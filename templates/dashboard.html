<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üèãÔ∏è Cube Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #7c3aed;
            --primary-light: #a78bfa;
            --primary-dark: #5b21b6;
            --success: #10b981;
            --success-light: #34d399;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-dark: #0a0a12;
            --bg-card: #12121f;
            --bg-card-hover: #1a1a2a;
            --bg-input: #0d0d16;
            --text-primary: #ffffff;
            --text-secondary: #b8b8d0;
            --text-muted: #6b6b80;
            --border: #1f1f35;
            --border-light: #2a2a45;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ============================================
           HEADER - Always visible with gym counter
           ============================================ */
        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: linear-gradient(180deg, var(--bg-dark) 0%, rgba(10, 10, 18, 0.95) 100%);
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            border-bottom: 1px solid var(--border);
        }

        .header-content {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            font-size: 1.5rem;
        }

        .logo-text {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .live-counter {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 30px;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.6;
                transform: scale(0.9);
            }
        }

        .live-count {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--success);
        }

        .live-label {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        /* ============================================
           TAB NAVIGATION
           ============================================ */
        .tab-nav {
            max-width: 900px;
            margin: 0 auto;
            padding: 16px 20px 0;
        }

        .tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-card);
            padding: 4px;
            border-radius: 14px;
            border: 1px solid var(--border);
        }

        .tab {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            border-radius: 10px;
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab:hover {
            color: var(--text-secondary);
            background: var(--bg-card-hover);
        }

        .tab.active {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }

        .tab-icon {
            font-size: 1.1rem;
        }

        /* ============================================
           MAIN CONTENT
           ============================================ */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ============================================
           CARDS
           ============================================ */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border);
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ============================================
           QUICK STATS ROW
           ============================================ */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-box {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 4px;
        }

        /* ============================================
           CALENDAR
           ============================================ */
        .month-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .month-nav button {
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: var(--text-primary);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .month-nav button:hover {
            background: var(--primary);
            border-color: var(--primary);
        }

        .current-month {
            font-size: 1.1rem;
            font-weight: 600;
            min-width: 160px;
            text-align: center;
        }

        .calendar-grid {
            background: var(--bg-input);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid var(--border);
        }

        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
            margin-bottom: 8px;
        }

        .weekday {
            text-align: center;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            padding: 8px 4px;
            text-transform: uppercase;
        }

        .days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
        }

        .day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--bg-card);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            padding: 4px;
            min-height: 45px;
            border: 1px solid transparent;
        }

        .day:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-light);
            transform: scale(1.02);
        }

        .day.other-month {
            opacity: 0.3;
            background: transparent;
        }

        .day.today {
            border: 2px solid var(--primary);
            background: rgba(124, 58, 237, 0.1);
        }

        .day.has-workout {
            background: linear-gradient(145deg, rgba(124, 58, 237, 0.15), rgba(16, 185, 129, 0.1));
            border-color: var(--primary-dark);
        }

        .day-number {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .day-icons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 2px;
            font-size: 1.1rem;
        }

        /* ============================================
           LEGEND
           ============================================ */
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            padding: 16px;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-top: 16px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* ============================================
           STATISTICS - Charts
           ============================================ */
        .chart-container {
            margin-bottom: 20px;
        }

        .weekly-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            height: 180px;
            gap: 6px;
            padding: 30px 4px 0;
        }

        .chart-bar-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            height: 100%;
        }

        .chart-bar {
            width: 100%;
            max-width: 35px;
            background: linear-gradient(180deg, var(--primary), var(--primary-dark));
            border-radius: 5px 5px 0 0;
            min-height: 4px;
            transition: all 0.3s;
            position: relative;
        }

        .chart-bar:hover {
            filter: brightness(1.2);
        }

        .chart-bar-value {
            position: absolute;
            top: -22px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .chart-bar-label {
            font-size: 0.6rem;
            color: var(--text-muted);
            margin-top: 6px;
        }

        /* Best Hours - Modern Chart Design */
        .hourly-chart-container {
            background: rgba(30, 30, 45, 0.6);
            border-radius: 16px;
            padding: 20px 24px 30px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            margin-bottom: 20px;
        }

        .hourly-chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .hourly-chart-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .hourly-chart-legend {
            display: flex;
            gap: 16px;
            font-size: 0.7rem;
        }

        .legend-item-chart {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-muted);
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 3px;
        }

        .legend-dot.green {
            background: #22c55e;
        }

        .legend-dot.yellow {
            background: #eab308;
        }

        .legend-dot.red {
            background: #ef4444;
        }

        .hourly-chart {
            display: flex;
            align-items: flex-end;
            height: 180px;
            gap: 6px;
            padding: 30px 0 35px;
            position: relative;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .hourly-chart::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 30px;
            bottom: 35px;
            background: repeating-linear-gradient(to bottom,
                    rgba(255, 255, 255, 0.03) 0px,
                    rgba(255, 255, 255, 0.03) 1px,
                    transparent 1px,
                    transparent 25%);
            pointer-events: none;
        }

        .hour-bar-wrapper {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            flex: 1;
            height: 100%;
            position: relative;
            padding-left: 2px;
        }

        .hour-bar {
            width: calc(100% - 4px);
            max-width: 38px;
            min-width: 18px;
            margin-left: auto;
            margin-right: auto;
            background: linear-gradient(180deg, #fbbf24 0%, #d97706 100%);
            border-radius: 6px 6px 3px 3px;
            min-height: 4px;
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
        }

        .hour-bar:hover {
            transform: scaleY(1.02) translateY(-2px);
            filter: brightness(1.15);
        }

        .hour-bar.low {
            background: linear-gradient(180deg, #4ade80 0%, #16a34a 100%);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.35);
        }

        .hour-bar.medium {
            background: linear-gradient(180deg, #fbbf24 0%, #d97706 100%);
            box-shadow: 0 4px 12px rgba(234, 179, 8, 0.35);
        }

        .hour-bar.high {
            background: linear-gradient(180deg, #f87171 0%, #dc2626 100%);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.35);
        }

        .hour-bar.no-data {
            background: rgba(100, 100, 120, 0.3);
            box-shadow: none;
        }

        .hour-bar-value {
            position: absolute;
            top: -22px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.72rem;
            font-weight: 700;
            color: var(--text-primary);
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
            white-space: nowrap;
        }

        .hour-label {
            font-size: 0.68rem;
            font-weight: 500;
            color: var(--text-muted);
            position: absolute;
            bottom: -24px;
            left: -2px;
            transform: translateX(-50%);
            white-space: nowrap;
        }

        .hour-label-end {
            position: absolute;
            right: 0;
            bottom: -24px;
            font-size: 0.68rem;
            font-weight: 500;
            color: var(--text-muted);
            transform: translateX(50%);
        }


        .best-hours-summary {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .best-hour-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--success);
        }

        /* Heatmap */
        .heatmap-container {
            overflow-x: auto;
            padding: 10px 0;
        }

        .heatmap {
            display: grid;
            grid-template-columns: repeat(53, 1fr);
            gap: 2px;
            min-width: 650px;
        }

        .heatmap-day {
            width: 10px;
            height: 10px;
            border-radius: 2px;
            background: var(--bg-input);
            transition: all 0.2s;
        }

        .heatmap-day:hover {
            transform: scale(1.4);
            z-index: 1;
        }

        .heatmap-day.level-1 {
            background: #0e4429;
        }

        .heatmap-day.level-2 {
            background: #006d32;
        }

        .heatmap-day.level-3 {
            background: #26a641;
        }

        .heatmap-day.level-4 {
            background: #39d353;
        }

        .heatmap-months {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            min-width: 650px;
        }

        .heatmap-months span {
            font-size: 0.6rem;
            color: var(--text-muted);
        }

        .heatmap-legend {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 10px;
            justify-content: flex-end;
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        .heatmap-legend-box {
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }

        /* Comparison */
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 16px;
            align-items: center;
        }

        .comparison-card {
            background: var(--bg-input);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .comparison-month {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 6px;
            text-transform: capitalize;
        }

        .comparison-value {
            font-size: 2.2rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .comparison-label {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .comparison-change {
            font-size: 1rem;
            font-weight: 700;
            padding: 8px 14px;
            border-radius: 16px;
        }

        .comparison-change.positive {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success-light);
        }

        .comparison-change.negative {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .comparison-change.neutral {
            background: var(--bg-card);
            color: var(--text-muted);
        }

        /* ============================================
           MORE TAB - Settings
           ============================================ */
        .action-button {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            padding: 16px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            margin-bottom: 10px;
        }

        .action-button:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-light);
        }

        .action-button .icon {
            font-size: 1.3rem;
        }

        .action-button .label {
            flex: 1;
            text-align: left;
        }

        .action-button .arrow {
            color: var(--text-muted);
        }

        /* ============================================
           MODAL
           ============================================ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 24px;
            width: 95%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
        }

        .body-parts-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
        }

        .body-part-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .body-part-btn:hover {
            background: var(--bg-card-hover);
        }

        .body-part-btn.selected {
            border-color: var(--primary);
            background: rgba(124, 58, 237, 0.15);
        }

        .body-part-emoji {
            font-size: 1.4rem;
        }

        .body-part-name {
            font-size: 0.85rem;
            font-weight: 500;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .modal-btn.secondary {
            background: var(--bg-input);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .modal-btn.danger {
            background: var(--danger);
            color: white;
        }

        /* ============================================
           RESPONSIVE
           ============================================ */
        @media (max-width: 600px) {
            .header-content {
                flex-direction: column;
                gap: 10px;
            }

            .quick-stats {
                grid-template-columns: repeat(3, 1fr);
            }

            .stat-value {
                font-size: 1.4rem;
            }

            .day {
                min-height: 50px;
                padding: 4px;
            }

            .day-number {
                font-size: 0.8rem;
            }

            .day-icons {
                font-size: 0.65rem;
            }

            .tab {
                padding: 10px 12px;
                font-size: 0.8rem;
            }

            .tab-icon {
                font-size: 1rem;
            }

            /* Hourly chart mobile fixes - horizontal scroll */
            .hourly-chart {
                overflow-x: auto;
                padding: 30px 10px 35px;
                min-width: 100%;
            }

            .hourly-chart>.hour-bar-wrapper {
                min-width: 30px;
                flex-shrink: 0;
            }

            .hour-bar {
                min-width: 22px;
                max-width: 28px;
            }
        }
    </style>
</head>

<body>
    <!-- LOGIN MODAL -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-modal">
            <div class="login-header">
                <span class="login-icon">üèãÔ∏è</span>
                <h2>Cube Si≈Çownia</h2>
            </div>

            <div id="loginForm" class="login-form">
                <div class="form-group">
                    <label>Nazwa u≈ºytkownika</label>
                    <input type="text" id="loginUsername" maxlength="20" autocomplete="username">
                </div>
                <div class="form-group">
                    <label>Has≈Ço</label>
                    <input type="password" id="loginPassword" maxlength="20" autocomplete="current-password">
                </div>
                <div id="loginError" class="login-error"></div>
                <button onclick="handleLogin()" class="btn-primary">Zaloguj siƒô</button>
                <div class="login-switch">
                    Nie masz konta? <a href="#" onclick="showRegister()">Zarejestruj siƒô</a>
                </div>
            </div>

            <div id="registerForm" class="login-form" style="display: none;">
                <div class="form-group">
                    <label>Nazwa u≈ºytkownika</label>
                    <input type="text" id="registerUsername" maxlength="20" autocomplete="username">
                </div>
                <div class="form-group">
                    <label>Has≈Ço</label>
                    <input type="password" id="registerPassword" maxlength="20" autocomplete="new-password">
                </div>
                <div id="registerError" class="login-error"></div>
                <button onclick="handleRegister()" class="btn-primary">Zarejestruj siƒô</button>
                <div class="login-switch">
                    Masz ju≈º konto? <a href="#" onclick="showLogin()">Zaloguj siƒô</a>
                </div>
            </div>
        </div>
    </div>

    <style>
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-overlay.hidden {
            display: none;
        }

        .login-modal {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 32px;
            width: 90%;
            max-width: 360px;
            border: 1px solid var(--border);
        }

        .login-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .login-icon {
            font-size: 3rem;
            display: block;
            margin-bottom: 8px;
        }

        .login-header h2 {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .login-form .form-group {
            margin-bottom: 16px;
        }

        .login-form label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .login-form input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
        }

        .login-form input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .login-error {
            color: var(--danger);
            font-size: 0.8rem;
            margin-bottom: 12px;
            min-height: 20px;
        }

        .btn-primary {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
        }

        .btn-primary:hover {
            filter: brightness(1.1);
        }

        .login-switch {
            text-align: center;
            margin-top: 16px;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .login-switch a {
            color: var(--primary-light);
            text-decoration: none;
        }

        /* User badge in header */
        .user-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .user-badge:hover {
            background: var(--bg-card-hover);
        }
    </style>

    <!-- HEADER -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <span class="logo-icon">üèãÔ∏è</span>
                <span class="logo-text">Cube Si≈Çownia #POWER</span>
            </div>
            <div class="live-counter">
                <div class="live-dot"></div>
                <span class="live-count" id="liveCount">--</span>
                <span class="live-label">os√≥b dzisiaj</span>
            </div>
            <div class="user-badge" id="userBadge" onclick="logout()">üë§ ---</div>
        </div>
    </header>

    <!-- TAB NAVIGATION -->
    <nav class="tab-nav">
        <div class="tabs">
            <button class="tab active" data-tab="calendar">
                <span class="tab-icon">üìÖ</span>
                <span>Kalendarz</span>
            </button>
            <button class="tab" data-tab="stats">
                <span class="tab-icon">üìä</span>
                <span>Statystyki</span>
            </button>
            <button class="tab" data-tab="strength">
                <span class="tab-icon">üí™</span>
                <span>Si≈Ça</span>
            </button>
            <button class="tab" data-tab="more">
                <span class="tab-icon">‚öôÔ∏è</span>
                <span>Wiƒôcej</span>
            </button>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="container">
        <!-- ============ CALENDAR TAB ============ -->
        <div class="tab-content active" id="tab-calendar">
            <!-- Quick Stats -->
            <div class="quick-stats">
                <div class="stat-box">
                    <div class="stat-value" id="weeklyCount">-</div>
                    <div class="stat-label">Ten tydzie≈Ñ</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="monthlyCount">-</div>
                    <div class="stat-label">Ten miesiƒÖc</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="mostTrained">-</div>
                    <div class="stat-label">Najczƒô≈õciej</div>
                </div>
            </div>

            <!-- Month Navigation -->
            <div class="month-nav">
                <button onclick="prevMonth()">‚Üê</button>
                <div class="current-month" id="currentMonth">Grudzie≈Ñ 2025</div>
                <button onclick="nextMonth()">‚Üí</button>
            </div>

            <!-- Calendar Grid -->
            <div class="calendar-grid">
                <div class="weekdays">
                    <div class="weekday">Pon</div>
                    <div class="weekday">Wt</div>
                    <div class="weekday">≈ör</div>
                    <div class="weekday">Czw</div>
                    <div class="weekday">Pt</div>
                    <div class="weekday">Sob</div>
                    <div class="weekday">Nd</div>
                </div>
                <div class="days" id="calendarDays"></div>
            </div>

            <!-- Legend -->
            <div class="legend" id="legend"></div>
        </div>

        <!-- ============ STATISTICS TAB ============ -->
        <div class="tab-content" id="tab-stats">
            <!-- Extended Occupancy Stats -->
            <div class="card">
                <div class="card-title">üìä Statystyki ob≈Ço≈ºenia</div>

                <!-- Quick stats row -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 16px;">
                    <div style="background: var(--bg-input); border-radius: 10px; padding: 12px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);"
                            id="statsAvgWeekday">
                            --</div>
                        <div style="font-size: 0.6rem; color: var(--text-muted);" id="statsWeekdayLabel">≈ör. piƒÖtek
                        </div>
                    </div>
                    <div style="background: var(--bg-input); border-radius: 10px; padding: 12px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);"
                            id="statsWeekdayHour">--</div>
                        <div style="font-size: 0.6rem; color: var(--text-muted);" id="statsWeekdayHourLabel">≈ör. piƒÖtek
                            o tej porze</div>
                    </div>
                    <div style="background: var(--bg-input); border-radius: 10px; padding: 12px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);" id="statsAvgHour">
                            --</div>
                        <div style="font-size: 0.6rem; color: var(--text-muted);">≈ör. o tej porze</div>
                    </div>
                    <div style="background: var(--bg-input); border-radius: 10px; padding: 12px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--text-primary);" id="statsLiveNow">
                            --
                        </div>
                        <div style="font-size: 0.6rem; color: var(--text-muted);">Teraz</div>
                    </div>
                </div>

                <!-- Daily averages chart -->
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 10px;">üìÖ ≈örednia dla
                        ka≈ºdego dnia tygodnia:</div>
                    <div id="dailyChart"
                        style="display: flex; align-items: flex-end; justify-content: space-between; height: 140px; gap: 4px; padding-top: 25px;">
                        <div style="text-align: center; width: 100%; color: var(--text-muted);">≈Åadowanie...</div>
                    </div>
                </div>

                <!-- Hourly averages chart -->
                <div class="hourly-chart-container">
                    <div class="hourly-chart-header">
                        <div class="hourly-chart-title">
                            ‚è∞ ≈örednia wej≈õƒá na godzinƒô (6-23)
                        </div>
                        <div class="hourly-chart-legend">
                            <div class="legend-item-chart">
                                <div class="legend-dot green"></div>
                                <span>Ma≈Ço</span>
                            </div>
                            <div class="legend-item-chart">
                                <div class="legend-dot yellow"></div>
                                <span>≈örednio</span>
                            </div>
                            <div class="legend-item-chart">
                                <div class="legend-dot red"></div>
                                <span>Du≈ºo</span>
                            </div>
                        </div>
                    </div>
                    <div id="hourlyChart" class="hourly-chart">
                        <div style="text-align: center; padding: 40px; width: 100%; color: var(--text-muted);">
                            ≈Åadowanie...</div>
                    </div>
                </div>


                <!-- Best/Worst times -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <!-- Best times -->
                    <div
                        style="background: rgba(16, 185, 129, 0.1); border-radius: 12px; padding: 14px; border: 1px solid rgba(16, 185, 129, 0.2);">
                        <div style="font-size: 0.75rem; color: var(--success); margin-bottom: 10px; font-weight: 600;">
                            üèÜ TOP 3 Najlepsze</div>
                        <div id="bestTimesList" style="display: flex; flex-direction: column; gap: 6px;">
                            <div style="color: var(--text-muted); font-size: 0.8rem;">≈Åadowanie...</div>
                        </div>
                    </div>
                    <!-- Worst times -->
                    <div
                        style="background: rgba(239, 68, 68, 0.1); border-radius: 12px; padding: 14px; border: 1px solid rgba(239, 68, 68, 0.2);">
                        <div style="font-size: 0.75rem; color: var(--danger); margin-bottom: 10px; font-weight: 600;">‚ö†Ô∏è
                            TOP 3 Najgorsze</div>
                        <div id="worstTimesList" style="display: flex; flex-direction: column; gap: 6px;">
                            <div style="color: var(--text-muted); font-size: 0.8rem;">≈Åadowanie...</div>
                        </div>
                    </div>
                </div>

                <!-- New Year Effect Card -->
                <div id="newYearCard"
                    style="margin-top: 16px; background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(168, 85, 247, 0.15)); border-radius: 12px; padding: 16px; border: 1px solid rgba(139, 92, 246, 0.3);">
                    <div style="font-size: 0.85rem; color: #a78bfa; margin-bottom: 12px; font-weight: 600;">
                        üéÜ EFEKT NOWOROCZNY
                    </div>

                    <div style="display: flex; flex-wrap: wrap; gap: 24px;">
                        <!-- LEFT COLUMN: Main Stats -->
                        <div style="flex: 1; min-width: 220px; display: flex; flex-direction: column; gap: 10px;">
                            <!-- Main percentage change -->
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span
                                    style="font-size: 1.1rem; background: rgba(255,255,255,0.1); padding: 6px; border-radius: 8px;">üìà</span>
                                <span id="newYearMainChange"
                                    style="font-size: 0.95rem; font-weight: 700; color: var(--text-primary);">--</span>
                            </div>

                            <!-- Today's weekday comparison -->
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span
                                    style="font-size: 1.1rem; background: rgba(255,255,255,0.1); padding: 6px; border-radius: 8px;">üìÖ</span>
                                <span id="newYearWeekday"
                                    style="font-size: 0.8rem; color: var(--text-secondary); line-height: 1.4;">--</span>
                            </div>

                            <!-- Peak day -->
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span
                                    style="font-size: 1.1rem; background: rgba(255,255,255,0.1); padding: 6px; border-radius: 8px;">üèÜ</span>
                                <span id="newYearPeak"
                                    style="font-size: 0.8rem; color: var(--text-secondary);">--</span>
                            </div>
                        </div>

                        <!-- RIGHT COLUMN: Weekly Trend -->
                        <!-- Using display:none initially, JS toggles to block. 
                             Since block layout works fine for vertical stacking, we don't need flex here. -->
                        <div id="newYearTrend"
                            style="flex: 1; min-width: 220px; display: none; border-left: 1px solid rgba(139, 92, 246, 0.2); padding-left: 24px;">
                            <div
                                style="font-size: 0.75rem; color: #a78bfa; margin-bottom: 8px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                                üìä Trend Tygodniowy
                            </div>
                            <div id="newYearWeeklyTrend"
                                style="font-size: 0.85rem; color: var(--text-primary); margin-bottom: 8px; font-weight: 500; line-height: 1.5;">
                                --</div>
                            <div id="newYearDecay"
                                style="display: flex; align-items: center; gap: 8px; font-size: 0.75rem; background: rgba(234, 179, 8, 0.1); padding: 4px 8px; border-radius: 4px; border: 1px solid rgba(234, 179, 8, 0.2); width: fit-content;">
                                <span>‚ö†Ô∏è</span>
                                <span id="newYearDecayText" style="color: var(--warning);">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Weekly Chart -->
            <div class="card">
                <div class="card-title">üìà Treningi tygodniowe (12 tyg.)</div>
                <div class="weekly-chart" id="weeklyChart"></div>
            </div>

            <!-- Month Comparison -->
            <div class="card">
                <div class="card-title">‚öñÔ∏è Por√≥wnanie miesiƒôcy</div>
                <div class="comparison-grid">
                    <div class="comparison-card">
                        <div class="comparison-month" id="prevMonthName">Listopad</div>
                        <div class="comparison-value" id="prevMonthCount">-</div>
                        <div class="comparison-label">trening√≥w</div>
                    </div>
                    <div class="comparison-change neutral" id="comparisonChange">0%</div>
                    <div class="comparison-card">
                        <div class="comparison-month" id="currMonthName">Grudzie≈Ñ</div>
                        <div class="comparison-value" id="currMonthCount">-</div>
                        <div class="comparison-label">trening√≥w</div>
                    </div>
                </div>
            </div>

            <!-- Yearly Heatmap - Simple -->
            <div class="card">
                <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>üî• Aktywno≈õƒá treningowa</span>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <button onclick="prevHeatmapYear()"
                            style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); padding: 6px 12px; cursor: pointer; font-size: 0.9rem;">‚Üê</button>
                        <span id="heatmapYear"
                            style="font-size: 0.9rem; font-weight: 600; min-width: 50px; text-align: center;">2025</span>
                        <button onclick="nextHeatmapYear()"
                            style="background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); padding: 6px 12px; cursor: pointer; font-size: 0.9rem;">‚Üí</button>
                    </div>
                </div>
                <div id="faceitHeatmap" style="display: flex; gap: 8px; overflow-x: auto; padding: 5px 0;"></div>
                <div
                    style="display: flex; justify-content: flex-end; align-items: center; gap: 8px; margin-top: 10px; font-size: 0.65rem; color: var(--text-muted);">
                    <div style="width: 12px; height: 12px; background: var(--bg-input); border-radius: 3px;"></div>
                    <span>Brak treningu</span>
                    <div style="width: 12px; height: 12px; background: #10b981; border-radius: 3px; margin-left: 10px;">
                    </div>
                    <span>Trening</span>
                </div>
            </div>
        </div>

        <!-- ============ STRENGTH TAB ============ -->
        <div class="tab-content" id="tab-strength">
            <!-- Personal Records -->
            <div class="card">
                <div class="card-title">üèÜ Osobiste rekordy (PR)</div>
                <div id="recordsGrid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    <div style="text-align: center; padding: 20px; color: var(--text-muted);">≈Åadowanie...</div>
                </div>
            </div>

            <!-- Progression Chart -->
            <div class="card">
                <div class="card-title">üìà Progresja ciƒô≈ºaru</div>
                <div style="margin-bottom: 12px;">
                    <select id="progressionSelect" onchange="fetchProgression(this.value)" style="
                        width: 100%;
                        padding: 12px;
                        background: var(--bg-input);
                        border: 1px solid var(--border);
                        border-radius: 10px;
                        color: var(--text-primary);
                        font-size: 0.9rem;
                    ">
                        <option value="">Wybierz partiƒô cia≈Ça...</option>
                    </select>
                </div>
                <div class="progression-chart" id="progressionChart"
                    style="height: 150px; display: flex; align-items: flex-end; gap: 4px; padding-top: 25px;">
                    <div style="text-align: center; width: 100%; color: var(--text-muted); font-size: 0.85rem;">
                        Wybierz partiƒô cia≈Ça aby zobaczyƒá progresjƒô
                    </div>
                </div>
            </div>
        </div>

        <!-- ============ MORE TAB ============ -->
        <div class="tab-content" id="tab-more">
            <div class="card">
                <div class="card-title">üíæ Eksport danych</div>
                <button class="action-button" onclick="downloadBackup()">
                    <span class="icon">üì¶</span>
                    <span class="label">Pobierz pe≈Çny backup</span>
                    <span class="arrow">‚Üí</span>
                </button>
                <button class="action-button" onclick="downloadWorkouts()">
                    <span class="icon">üèãÔ∏è</span>
                    <span class="label">Pobierz tylko treningi</span>
                    <span class="arrow">‚Üí</span>
                </button>
            </div>

            <div class="card">
                <div class="card-title">‚ÑπÔ∏è Informacje</div>
                <p style="color: var(--text-muted); font-size: 0.85rem; line-height: 1.6;">
                    <strong>Cube Tracker</strong><br>
                    Wersja 2.0 - Dashboard<br><br>
                    ≈öled≈∫ swoje treningi, sprawdzaj ob≈Ço≈ºenie si≈Çowni i analizuj statystyki.<br><br>
                    <span style="color: var(--primary-light);">stworzone przez izim üí™</span>
                </p>
            </div>

            <div class="card">
                <div class="card-title">üé® Legenda partii cia≈Ça</div>
                <div class="legend" id="fullLegend" style="margin-top: 0;"></div>
            </div>
        </div>
    </main>

    <!-- Modal for adding/editing workout -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-title" id="modalTitle">Dodaj trening</div>
            <div class="body-parts-grid" id="bodyPartsGrid"></div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeModal()">Anuluj</button>
                <button class="modal-btn danger" id="deleteBtn" onclick="deleteWorkout()"
                    style="display: none;">Usu≈Ñ</button>
                <button class="modal-btn primary" onclick="saveWorkout()">Zapisz</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // STATE
        // ============================================
        const MONTHS_PL = ['Stycze≈Ñ', 'Luty', 'Marzec', 'Kwiecie≈Ñ', 'Maj', 'Czerwiec',
            'Lipiec', 'Sierpie≈Ñ', 'Wrzesie≈Ñ', 'Pa≈∫dziernik', 'Listopad', 'Grudzie≈Ñ'];

        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth() + 1;
        let selectedDate = null;
        let selectedParts = [];
        let weightData = {};  // {part: {kg, sets, reps}}
        let workoutsData = {};
        let bodyPartsConfig = {};
        let heatmapYear = new Date().getFullYear();  // Year for heatmap navigation

        // ============================================
        // TAB SWITCHING
        // ============================================
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');

                // Load data on first visit
                if (tab.dataset.tab === 'stats' && !document.getElementById('weeklyChart').hasChildNodes()) {
                    loadStatistics();
                }
                if (tab.dataset.tab === 'strength' && !document.getElementById('recordsGrid').querySelector('.record-card')) {
                    loadStrengthData();
                }
            });
        });

        // ============================================
        // AUTHENTICATION
        // ============================================
        let currentUser = null;

        function getStoredUser() {
            const stored = localStorage.getItem('gym_user');
            if (stored) {
                try {
                    return JSON.parse(stored);
                } catch (e) {
                    return null;
                }
            }
            return null;
        }

        function storeUser(user) {
            localStorage.setItem('gym_user', JSON.stringify(user));
            currentUser = user;
        }

        function clearUser() {
            localStorage.removeItem('gym_user');
            currentUser = null;
        }

        function showLoginOverlay() {
            document.getElementById('loginOverlay').classList.remove('hidden');
        }

        function hideLoginOverlay() {
            document.getElementById('loginOverlay').classList.add('hidden');
        }

        function showLogin() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginError').textContent = '';
        }

        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('registerError').textContent = '';
        }

        async function handleLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');

            if (!username || !password) {
                errorEl.textContent = 'Wype≈Çnij wszystkie pola';
                return;
            }

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (data.success) {
                    storeUser({ user_id: data.user_id, username: data.username });
                    hideLoginOverlay();
                    updateUserBadge();
                    startApp();
                } else {
                    errorEl.textContent = data.error || 'B≈ÇƒÖd logowania';
                }
            } catch (e) {
                errorEl.textContent = 'B≈ÇƒÖd po≈ÇƒÖczenia';
            }
        }

        async function handleRegister() {
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const errorEl = document.getElementById('registerError');

            if (!username || !password) {
                errorEl.textContent = 'Wype≈Çnij wszystkie pola';
                return;
            }

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (data.success) {
                    storeUser({ user_id: data.user_id, username: data.username });
                    hideLoginOverlay();
                    updateUserBadge();
                    startApp();
                } else {
                    errorEl.textContent = data.error || 'B≈ÇƒÖd rejestracji';
                }
            } catch (e) {
                errorEl.textContent = 'B≈ÇƒÖd po≈ÇƒÖczenia';
            }
        }

        function logout() {
            if (confirm('Czy na pewno chcesz siƒô wylogowaƒá?')) {
                clearUser();
                location.reload();
            }
        }

        function updateUserBadge() {
            if (currentUser) {
                const badge = document.getElementById('userBadge');
                if (badge) {
                    badge.textContent = 'üë§ ' + currentUser.username;
                }
            }
        }

        function checkAuth() {
            currentUser = getStoredUser();
            if (currentUser) {
                hideLoginOverlay();
                updateUserBadge();
                return true;
            } else {
                showLoginOverlay();
                return false;
            }
        }

        // Allow Enter key to submit forms
        document.getElementById('loginPassword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
        });
        document.getElementById('registerPassword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleRegister();
        });

        // ============================================
        // INITIALIZATION
        // ============================================
        async function startApp() {
            // Fetch live count first (non-blocking) so counter appears immediately
            fetchLiveCount();

            await fetchDashboard();
            await fetchMonthWorkouts();
            renderCalendar();
            renderLegend();

            // Auto-refresh live count
            setInterval(fetchLiveCount, 60000);
        }

        function init() {
            if (checkAuth()) {
                startApp();
            }
        }

        // ============================================
        // LIVE COUNTER
        // ============================================
        async function fetchLiveCount() {
            try {
                const response = await fetch('/api/occupancy');
                const data = await response.json();
                // Display count even if status is 'initializing' - show what we have
                if (data.entries_today !== undefined && data.entries_today !== null) {
                    document.getElementById('liveCount').textContent = data.entries_today;
                }
            } catch (error) {
                console.error('Error fetching live count:', error);
            }
        }

        // ============================================
        // DASHBOARD DATA
        // ============================================
        async function fetchDashboard() {
            try {
                const userParam = currentUser ? `?user_id=${currentUser.user_id}` : '';
                const response = await fetch(`/api/workouts/dashboard${userParam}`);
                const data = await response.json();

                document.getElementById('weeklyCount').textContent = data.weekly_count || 0;
                document.getElementById('monthlyCount').textContent = data.monthly_count || 0;

                if (data.most_trained) {
                    document.getElementById('mostTrained').textContent =
                        data.most_trained.emoji + ' ' + data.most_trained.count;
                }

                if (data.body_parts_config) {
                    bodyPartsConfig = data.body_parts_config;
                }
            } catch (error) {
                console.error('Error fetching dashboard:', error);
            }
        }

        // ============================================
        // CALENDAR
        // ============================================
        async function fetchMonthWorkouts() {
            try {
                const userParam = currentUser ? `?user_id=${currentUser.user_id}` : '';
                const response = await fetch(`/api/workouts/month/${currentYear}/${currentMonth}${userParam}`);
                const data = await response.json();

                workoutsData = {};
                if (data.workouts) {
                    for (const workout of data.workouts) {
                        workoutsData[workout.date] = workout;
                    }
                }

                if (data.body_parts_config) {
                    bodyPartsConfig = data.body_parts_config;
                }
            } catch (error) {
                console.error('Error fetching workouts:', error);
            }
        }

        function renderCalendar() {
            const container = document.getElementById('calendarDays');
            container.innerHTML = '';

            document.getElementById('currentMonth').textContent =
                `${MONTHS_PL[currentMonth - 1]} ${currentYear}`;

            const firstDay = new Date(currentYear, currentMonth - 1, 1);
            const lastDay = new Date(currentYear, currentMonth, 0);
            const totalDays = lastDay.getDate();

            let startDay = firstDay.getDay() - 1;
            if (startDay < 0) startDay = 6;

            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

            const prevMonthLastDay = new Date(currentYear, currentMonth - 1, 0);
            const prevMonthDays = prevMonthLastDay.getDate();

            // Previous month days
            for (let i = startDay - 1; i >= 0; i--) {
                const day = prevMonthDays - i;
                const cell = document.createElement('div');
                cell.className = 'day other-month';
                cell.innerHTML = `<div class="day-number">${day}</div>`;
                container.appendChild(cell);
            }

            // Current month days
            for (let day = 1; day <= totalDays; day++) {
                const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const workout = workoutsData[dateStr];

                const cell = document.createElement('div');
                cell.className = 'day';

                if (dateStr === todayStr) {
                    cell.classList.add('today');
                }

                if (workout) {
                    cell.classList.add('has-workout');
                }

                cell.innerHTML = `
                    <div class="day-number">${day}</div>
                    <div class="day-icons">${workout ? getWorkoutIcons(workout.body_parts) : ''}</div>
                `;

                cell.onclick = () => openModal(dateStr);
                container.appendChild(cell);
            }

            // Next month days
            const totalCells = startDay + totalDays;
            const targetCells = Math.ceil(totalCells / 7) * 7;
            const nextMonthDays = targetCells - totalCells;

            for (let day = 1; day <= nextMonthDays; day++) {
                const cell = document.createElement('div');
                cell.className = 'day other-month';
                cell.innerHTML = `<div class="day-number">${day}</div>`;
                container.appendChild(cell);
            }
        }

        function getWorkoutIcons(parts) {
            if (!parts || !parts.length) return '';
            return parts.map(p => `<span>${bodyPartsConfig[p]?.emoji || ''}</span>`).join('');
        }

        function renderLegend() {
            const container = document.getElementById('legend');
            const fullLegend = document.getElementById('fullLegend');
            container.innerHTML = '';
            fullLegend.innerHTML = '';

            for (const [key, config] of Object.entries(bodyPartsConfig)) {
                const item = `<div class="legend-item"><span>${config.emoji}</span><span>${config.name}</span></div>`;
                container.innerHTML += item;
                fullLegend.innerHTML += item;
            }
        }

        function prevMonth() {
            currentMonth--;
            if (currentMonth < 1) {
                currentMonth = 12;
                currentYear--;
            }
            fetchMonthWorkouts().then(renderCalendar);
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 12) {
                currentMonth = 1;
                currentYear++;
            }
            fetchMonthWorkouts().then(renderCalendar);
        }

        // ============================================
        // MODAL
        // ============================================
        function renderBodyPartsGrid() {
            const container = document.getElementById('bodyPartsGrid');
            container.innerHTML = '';

            for (const [key, config] of Object.entries(bodyPartsConfig)) {
                const isSelected = selectedParts.includes(key);
                const wd = weightData[key] || { kg: '', sets: '', reps: '' };

                const wrapper = document.createElement('div');
                wrapper.style.cssText = `
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    padding: 12px 14px;
                    background: ${isSelected ? 'rgba(124, 58, 237, 0.15)' : 'var(--bg-input)'};
                    border: 2px solid ${isSelected ? 'var(--primary)' : 'var(--border)'};
                    border-radius: 12px;
                    cursor: pointer;
                    transition: all 0.2s;
                `;

                // Checkbox area
                const checkArea = document.createElement('div');
                checkArea.style.cssText = 'display: flex; align-items: center; gap: 10px; min-width: 120px;';
                checkArea.innerHTML = `
                    <div style="width: 20px; height: 20px; border: 2px solid ${isSelected ? 'var(--primary)' : 'var(--border)'}; border-radius: 5px; display: flex; align-items: center; justify-content: center; background: ${isSelected ? 'var(--primary)' : 'transparent'};">
                        ${isSelected ? '<span style="color: white; font-size: 0.7rem;">‚úì</span>' : ''}
                    </div>
                    <span style="font-size: 1.3rem;">${config.emoji}</span>
                    <span style="font-size: 0.85rem; font-weight: 500;">${config.name}</span>
                `;
                checkArea.onclick = () => togglePart(key);
                wrapper.appendChild(checkArea);

                // Spacer
                const spacer = document.createElement('div');
                spacer.style.flex = '1';
                wrapper.appendChild(spacer);

                // Weight inputs (always visible, but disabled if not selected)
                const inputsArea = document.createElement('div');
                inputsArea.style.cssText = 'display: flex; align-items: center; gap: 6px;';
                inputsArea.innerHTML = `
                    <input type="text" inputmode="numeric" placeholder="kg" value="${wd.kg}" 
                        ${isSelected ? '' : 'disabled'}
                        onchange="updateWeight('${key}', 'kg', this.value)"
                        onclick="event.stopPropagation()"
                        style="width: 45px; padding: 8px 4px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 0.8rem; text-align: center; opacity: ${isSelected ? '1' : '0.4'};">
                    <span style="font-size: 0.7rem; color: var(--text-muted);">√ó</span>
                    <input type="text" inputmode="numeric" placeholder="ser" value="${wd.sets}"
                        ${isSelected ? '' : 'disabled'}
                        onchange="updateWeight('${key}', 'sets', this.value)"
                        onclick="event.stopPropagation()"
                        style="width: 35px; padding: 8px 4px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 0.8rem; text-align: center; opacity: ${isSelected ? '1' : '0.4'};">
                    <span style="font-size: 0.7rem; color: var(--text-muted);">√ó</span>
                    <input type="text" inputmode="numeric" placeholder="powt" value="${wd.reps}"
                        ${isSelected ? '' : 'disabled'}
                        onchange="updateWeight('${key}', 'reps', this.value)"
                        onclick="event.stopPropagation()"
                        style="width: 40px; padding: 8px 4px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 0.8rem; text-align: center; opacity: ${isSelected ? '1' : '0.4'};">
                `;
                wrapper.appendChild(inputsArea);

                container.appendChild(wrapper);
            }
        }

        function updateWeight(part, field, value) {
            if (!weightData[part]) {
                weightData[part] = { kg: '', sets: '', reps: '' };
            }
            weightData[part][field] = value ? parseInt(value) : '';
        }

        function togglePart(part) {
            const idx = selectedParts.indexOf(part);
            if (idx > -1) {
                selectedParts.splice(idx, 1);
                delete weightData[part];
            } else {
                selectedParts.push(part);
            }
            renderBodyPartsGrid();
        }

        function openModal(dateStr) {
            selectedDate = dateStr;
            const workout = workoutsData[dateStr];
            selectedParts = workout ? [...workout.body_parts] : [];
            weightData = workout && workout.weight_data ? { ...workout.weight_data } : {};

            document.getElementById('modalTitle').textContent =
                workout ? `Edytuj trening (${dateStr})` : `Dodaj trening (${dateStr})`;
            document.getElementById('deleteBtn').style.display = workout ? 'block' : 'none';

            renderBodyPartsGrid();
            document.getElementById('modalOverlay').classList.add('show');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('show');
            selectedDate = null;
            selectedParts = [];
            weightData = {};
        }

        async function saveWorkout() {
            if (!selectedDate || selectedParts.length === 0) {
                alert('Wybierz przynajmniej jednƒÖ partiƒô cia≈Ça!');
                return;
            }

            try {
                const response = await fetch('/api/workout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date: selectedDate,
                        body_parts: selectedParts,
                        weight_data: weightData,
                        user_id: currentUser ? currentUser.user_id : null
                    })
                });

                if (response.ok) {
                    closeModal();
                    await fetchMonthWorkouts();
                    await fetchDashboard();
                    renderCalendar();
                } else {
                    const data = await response.json();
                    alert('B≈ÇƒÖd: ' + (data.error || 'Nieznany b≈ÇƒÖd'));
                }
            } catch (error) {
                console.error('Error saving workout:', error);
                alert('B≈ÇƒÖd po≈ÇƒÖczenia');
            }
        }

        async function deleteWorkout() {
            if (!selectedDate) return;
            if (!confirm('Czy na pewno chcesz usunƒÖƒá ten trening?')) return;

            try {
                const userParam = currentUser ? `?user_id=${currentUser.user_id}` : '';
                const response = await fetch(`/api/workout/${selectedDate}${userParam}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    closeModal();
                    await fetchMonthWorkouts();
                    await fetchDashboard();
                    renderCalendar();
                }
            } catch (error) {
                console.error('Error deleting workout:', error);
            }
        }

        // Close modal on overlay click
        document.getElementById('modalOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'modalOverlay') closeModal();
        });

        // ============================================
        // STATISTICS
        // ============================================
        function isGymOpen() {
            const now = new Date();
            const day = now.getDay();
            const hour = now.getHours();

            // Monday (1) to Friday (5)
            if (day >= 1 && day <= 5) {
                return hour >= 6 && hour < 23;
            }
            // Saturday (6) and Sunday (0)
            else {
                return hour >= 8 && hour < 20;
            }
        }

        function updateGymStatusUI() {
            if (!isGymOpen()) {
                const ids = ['statsAvgWeekday', 'statsWeekdayHour', 'statsAvgHour', 'statsLiveNow'];
                ids.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.textContent = 'Zamkniƒôte';
                        el.style.fontSize = '1rem';
                        el.style.color = 'var(--text-muted)';
                    }
                });
            }
        }

        async function loadStatistics() {
            await Promise.all([
                fetchExtendedStats(),
                fetchNewYearStats(),
                fetchWeeklyChart(),
                fetchYearlyHeatmap(),
                fetchComparison()
            ]);
        }

        async function fetchExtendedStats() {
            try {
                const [extendedRes, liveRes] = await Promise.all([
                    fetch('/api/analytics/extended'),
                    fetch('/api/occupancy')
                ]);
                const data = await extendedRes.json();
                const live = await liveRes.json();

                // Average for today's weekday (MAX daily)
                document.getElementById('statsAvgWeekday').textContent =
                    data.today_avg ? Math.round(data.today_avg) : '--';
                document.getElementById('statsWeekdayLabel').textContent =
                    data.weekday_name_full ? `≈ör. ${data.weekday_name_full}` : '≈ör. dzi≈õ';

                // Average for today's weekday at this hour (NEW)
                document.getElementById('statsWeekdayHour').textContent =
                    data.today_hour_avg !== undefined ? Math.round(data.today_hour_avg) : '--';
                document.getElementById('statsWeekdayHourLabel').textContent =
                    data.weekday_name_full ? `≈ör. ${data.weekday_name_full} o tej porze` : '≈ör. dzi≈õ o tej porze';

                // Average for current hour (all days)
                document.getElementById('statsAvgHour').textContent =
                    data.current_hour_avg ? Math.round(data.current_hour_avg) : '--';

                // Live count
                if (live.entries_today !== undefined) {
                    document.getElementById('statsLiveNow').textContent = live.entries_today;
                }

                // Render charts
                renderDailyChart(data.daily_averages || {});
                renderHourlyChart(data.hourly_averages || {});
                renderBestWorstTimes(data.best_times || [], data.worst_times || []);

                // Override with "Zamkniƒôte" if gym is closed
                updateGymStatusUI();

            } catch (error) {
                console.error('Error fetching extended stats:', error);
            }
        }

        async function fetchNewYearStats() {
            try {
                const response = await fetch('/api/analytics/new-year');
                const data = await response.json();

                if (!data.has_data) {
                    // Show card with placeholder text (fallback if server doesn't send sample data)
                    document.getElementById('newYearCard').style.display = 'block';
                    document.getElementById('newYearMainChange').textContent = 'Zbieranie danych...';
                    document.getElementById('newYearMainChange').style.fontSize = '0.85rem';
                    document.getElementById('newYearWeekday').textContent = 'Por√≥wnanie pojawi siƒô w styczniu';
                    document.getElementById('newYearPeak').textContent = data.reason || 'Brak wystarczajƒÖcych danych';

                    // Show right column with placeholder
                    document.getElementById('newYearTrend').style.display = 'block';
                    document.getElementById('newYearWeeklyTrend').textContent = 'Wykres dostƒôpny po 7 stycznia';
                    document.getElementById('newYearWeeklyTrend').style.color = 'var(--text-muted)';
                    document.getElementById('newYearDecay').style.display = 'none';
                    return;
                }

                // Show the card
                const card = document.getElementById('newYearCard');
                card.style.display = 'block';

                // Set title
                const titleEl = document.querySelector('#newYearCard > div:first-child');
                titleEl.innerHTML = 'üéÜ EFEKT NOWOROCZNY';

                // Main percentage change
                const change = data.overall_change;
                const sign = change >= 0 ? '+' : '';
                document.getElementById('newYearMainChange').textContent =
                    `${sign}${change}% wiƒôcej os√≥b ni≈º w grudniu`;
                document.getElementById('newYearMainChange').style.fontSize = '0.9rem';

                // Today's weekday comparison
                const weekdayChange = data.current_weekday_change;
                const weekdaySign = weekdayChange >= 0 ? '+' : '';
                document.getElementById('newYearWeekday').textContent =
                    `Dzisiaj (${data.current_weekday_name}): ${weekdaySign}${weekdayChange}% vs ≈õr. ${data.current_weekday_name.substring(0, 3)}. gru.`;

                // Peak day (safer parsing)
                if (data.january && data.january.peak_day) {
                    const peak = data.january.peak_day;
                    // peak.date is YYYY-MM-DD
                    const parts = peak.date.split('-');
                    const day = parseInt(parts[2], 10);
                    const monthIdx = parseInt(parts[1], 10) - 1;

                    const months = ['stycznia', 'lutego', 'marca', 'kwietnia', 'maja', 'czerwca',
                        'lipca', 'sierpnia', 'wrze≈õnia', 'pa≈∫dziernika', 'listopada', 'grudnia'];

                    document.getElementById('newYearPeak').textContent =
                        `Szczyt: ${day} ${months[monthIdx]} (${peak.occupancy} os√≥b)`;
                }

                // Weekly trend
                if (data.weekly_trend && data.weekly_trend.length >= 2) {
                    document.getElementById('newYearTrend').style.display = 'block';

                    // Build trend string: W1: +42% | W2: +38% ‚Üì | ...
                    const trendParts = data.weekly_trend.map((w, i) => {
                        // For mock data, we might want to show all weeks that are available
                        const percentChange = Math.round(w.percent - 100 + data.overall_change);
                        const arrow = i > 0 && w.change < 0 ? ' ‚Üì' : (i > 0 && w.change > 0 ? ' ‚Üë' : '');
                        return `W${w.week}: +${percentChange}%${arrow}`;
                    });
                    document.getElementById('newYearWeeklyTrend').textContent = trendParts.join(' | ');

                    // Decay rate
                    if (data.avg_weekly_decay !== 0) {
                        document.getElementById('newYearDecayText').textContent =
                            `Spadek ${data.avg_weekly_decay}%/tydzie≈Ñ`;
                    }
                } else {
                    document.getElementById('newYearTrend').style.display = 'none';
                }

            } catch (error) {
                console.error('Error fetching new year stats:', error);
                // Show placeholder on error
                document.getElementById('newYearCard').style.display = 'block';
                document.getElementById('newYearMainChange').textContent = 'Zbieranie danych...';
                document.getElementById('newYearWeekday').textContent = 'B≈ÇƒÖd pobierania danych';
                document.getElementById('newYearPeak').textContent = '';
                document.getElementById('newYearTrend').style.display = 'none';
            }
        }

        function renderDailyChart(dailyAverages) {
            const container = document.getElementById('dailyChart');
            if (!container) return;
            container.innerHTML = '';

            const days = ['Pon', 'Wt', '≈ör', 'Czw', 'Pt', 'Sob', 'Nd'];
            const values = days.map(d => dailyAverages[d] || 0);
            const maxVal = Math.max(...values, 1);

            const hasData = values.some(v => v > 0);
            if (!hasData) {
                container.innerHTML = `<div style="text-align: center; width: 100%; color: var(--text-muted);">Zbieranie danych...</div>`;
                return;
            }

            days.forEach((day, i) => {
                const val = values[i];
                const heightPercent = val > 0 ? (val / maxVal) * 100 : 5;

                const wrapper = document.createElement('div');
                wrapper.style.cssText = 'display: flex; flex-direction: column; align-items: center; flex: 1; height: 100%;';

                wrapper.innerHTML = `
                    <div style="
                        width: 100%;
                        max-width: 40px;
                        background: linear-gradient(180deg, var(--primary), var(--primary-dark));
                        border-radius: 5px 5px 0 0;
                        height: ${heightPercent}%;
                        min-height: 4px;
                        position: relative;
                        transition: all 0.3s;
                    ">
                        <span style="
                            position: absolute;
                            top: -20px;
                            left: 50%;
                            transform: translateX(-50%);
                            font-size: 0.7rem;
                            font-weight: 600;
                            color: var(--text-primary);
                        ">${val > 0 ? Math.round(val) : ''}</span>
                    </div>
                    <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 6px; font-weight: 500;">${day}</div>
                `;

                container.appendChild(wrapper);
            });
        }

        function renderHourlyChart(hourlyAverages) {
            const container = document.getElementById('hourlyChart');
            if (!container) return;
            container.innerHTML = '';

            const hours = [];
            for (let h = 6; h <= 22; h++) hours.push(h);

            const values = hours.map(h => hourlyAverages[h] || 0);
            const maxVal = Math.max(...values, 1);

            const hasData = values.some(v => v > 0);
            if (!hasData) {
                container.innerHTML = `<div style="text-align: center; padding: 50px; width: 100%; color: var(--text-muted); font-size: 0.9rem;">üìä Zbieranie danych...<br><span style="font-size: 0.75rem; opacity: 0.7;">Statystyki pojawiƒÖ siƒô po kilku dniach</span></div>`;
                return;
            }

            // Calculate thresholds for colors (33% and 66% of max)
            const lowThreshold = maxVal * 0.33;
            const highThreshold = maxVal * 0.66;

            hours.forEach((hour, i) => {
                const val = values[i];
                const heightPercent = val > 0 ? Math.max((val / maxVal) * 100, 8) : 5;

                const wrapper = document.createElement('div');
                wrapper.className = 'hour-bar-wrapper';

                // Determine color class based on value
                let barClass = 'hour-bar';
                if (val <= 0) {
                    barClass += ' low';  // Green for 0 entries (best time!)
                } else if (val <= lowThreshold) {
                    barClass += ' low';  // Green - few people
                } else if (val <= highThreshold) {
                    barClass += ' medium';  // Yellow - medium
                } else {
                    barClass += ' high';  // Red - many people
                }

                // Add hour label on the left edge of this slot - always show value (even 0)
                // For the last bar, also add the end label (23) inside the wrapper
                const isLast = i === hours.length - 1;
                wrapper.innerHTML = `
                    <div class="${barClass}" style="height: ${heightPercent}%;" title="${hour}:00-${hour + 1}:00 ‚Äî ≈õrednio ${Math.round(val)} wej≈õƒá">
                        <span class="hour-bar-value">${Math.round(val)}</span>
                    </div>
                    <div class="hour-label">${hour}</div>
                    ${isLast ? `<div class="hour-label-end">${hour + 1}</div>` : ''}
                `;

                container.appendChild(wrapper);
            });
        }




        function renderBestWorstTimes(bestTimes, worstTimes) {
            const bestContainer = document.getElementById('bestTimesList');
            const worstContainer = document.getElementById('worstTimesList');

            const medals = ['ü•á', 'ü•à', 'ü•â'];

            if (bestContainer) {
                if (bestTimes.length === 0) {
                    bestContainer.innerHTML = '<div style="color: var(--text-muted); font-size: 0.8rem;">Brak danych</div>';
                } else {
                    bestContainer.innerHTML = bestTimes.map((t, i) => `
                        <div style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; background: rgba(16, 185, 129, 0.15); border-radius: 8px;">
                            <span style="font-size: 1rem;">${medals[i] || '‚≠ê'}</span>
                            <span style="font-size: 0.8rem; font-weight: 500; color: var(--text-primary);">${t.label}</span>
                            <span style="font-size: 0.7rem; color: var(--success); margin-left: auto;">~${Math.round(t.avg)} os.</span>
                        </div>
                    `).join('');
                }
            }

            if (worstContainer) {
                if (worstTimes.length === 0) {
                    worstContainer.innerHTML = '<div style="color: var(--text-muted); font-size: 0.8rem;">Brak danych</div>';
                } else {
                    worstContainer.innerHTML = worstTimes.map((t, i) => `
                        <div style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; background: rgba(239, 68, 68, 0.15); border-radius: 8px;">
                            <span style="font-size: 1rem;">${medals[i] || 'üíÄ'}</span>
                            <span style="font-size: 0.8rem; font-weight: 500; color: var(--text-primary);">${t.label}</span>
                            <span style="font-size: 0.7rem; color: var(--danger); margin-left: auto;">~${Math.round(t.avg)} os.</span>
                        </div>
                    `).join('');
                }
            }
        }

        async function fetchWeeklyChart() {
            try {
                const userParam = currentUser ? `?user_id=${currentUser.user_id}` : '';
                const response = await fetch(`/api/analytics/weekly${userParam}`);
                const data = await response.json();
                if (data.weeks) {
                    renderWeeklyChart(data.weeks);
                }
            } catch (error) {
                console.error('Error fetching weekly chart:', error);
            }
        }

        function renderWeeklyChart(weeks) {
            const container = document.getElementById('weeklyChart');
            container.innerHTML = '';

            const maxCount = Math.max(...weeks.map(w => w.count), 1);

            weeks.forEach(week => {
                const wrapper = document.createElement('div');
                wrapper.className = 'chart-bar-wrapper';

                const heightPercent = (week.count / maxCount) * 100;
                const barHeight = Math.max(heightPercent, 3);

                // Parse dates for label (e.g., "9-15")
                const startDay = week.start_date ? new Date(week.start_date).getDate() : '';
                const endDay = week.end_date ? new Date(week.end_date).getDate() : '';
                const label = startDay && endDay ? `${startDay}-${endDay}` : week.week.split('-W')[1];

                wrapper.innerHTML = `
                    <div class="chart-bar" style="height: ${barHeight}%;">
                        <span class="chart-bar-value">${week.count}</span>
                    </div>
                    <div class="chart-bar-label">${label}</div>
                `;

                container.appendChild(wrapper);
            });
        }

        async function fetchYearlyHeatmap(year = null) {
            try {
                const targetYear = year || heatmapYear;
                const userParam = currentUser ? `?user_id=${currentUser.user_id}` : '';
                const response = await fetch(`/api/analytics/heatmap/${targetYear}${userParam}`);
                const data = await response.json();
                renderHeatmap(data, targetYear);
            } catch (error) {
                console.error('Error fetching heatmap:', error);
            }
        }

        function prevHeatmapYear() {
            if (heatmapYear > 2025) {
                heatmapYear--;
                document.getElementById('heatmapYear').textContent = heatmapYear;
                fetchYearlyHeatmap(heatmapYear);
            }
        }

        function nextHeatmapYear() {
            const maxYear = new Date().getFullYear() + 1;
            if (heatmapYear < maxYear) {
                heatmapYear++;
                document.getElementById('heatmapYear').textContent = heatmapYear;
                fetchYearlyHeatmap(heatmapYear);
            }
        }

        function renderHeatmap(data, year) {
            const container = document.getElementById('faceitHeatmap');
            if (!container) return;
            container.innerHTML = '';

            // Update year display
            document.getElementById('heatmapYear').textContent = year;

            const heatmapData = data.data || {};
            const monthNames = ['Sty', 'Lut', 'Mar', 'Kwi', 'Maj', 'Cze', 'Lip', 'Sie', 'Wrz', 'Pa≈∫', 'Lis', 'Gru'];
            const workoutColor = '#10b981'; // Green for workout days
            const emptyColor = 'var(--bg-input)';

            const today = new Date();

            // Show all 12 months for the selected year
            for (let month = 0; month < 12; month++) {
                const monthDiv = document.createElement('div');
                monthDiv.style.cssText = 'flex: 1; min-width: 100px;';

                // Month label
                const label = document.createElement('div');
                label.textContent = monthNames[month];
                label.style.cssText = 'font-size: 0.7rem; color: var(--text-muted); margin-bottom: 8px; text-align: center;';
                monthDiv.appendChild(label);

                // Days grid (7 cols x ~5 rows)
                const grid = document.createElement('div');
                grid.style.cssText = 'display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;';

                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const firstDay = new Date(year, month, 1).getDay();
                const startOffset = firstDay === 0 ? 6 : firstDay - 1; // Monday = 0

                // Empty cells for offset
                for (let i = 0; i < startOffset; i++) {
                    const empty = document.createElement('div');
                    empty.style.cssText = 'aspect-ratio: 1; width: 100%;';
                    grid.appendChild(empty);
                }

                // Day cells
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const hasWorkout = heatmapData[dateStr] && heatmapData[dateStr] > 0;
                    const isFuture = new Date(year, month, day) > today;

                    const cell = document.createElement('div');
                    cell.style.cssText = `
                        aspect-ratio: 1; width: 100%;
                        background: ${hasWorkout ? workoutColor : emptyColor}; 
                        border-radius: 2px;
                        opacity: ${isFuture ? '0.3' : '1'};
                    `;
                    if (hasWorkout) cell.title = `${day}.${month + 1}.${year} - trening`;
                    grid.appendChild(cell);
                }

                monthDiv.appendChild(grid);
                container.appendChild(monthDiv);
            }
        }


        async function fetchComparison() {
            try {
                const userParam = currentUser ? `?user_id=${currentUser.user_id}` : '';
                const response = await fetch(`/api/analytics/comparison${userParam}`);
                const data = await response.json();
                renderComparison(data);
            } catch (error) {
                console.error('Error fetching comparison:', error);
            }
        }

        function renderComparison(data) {
            document.getElementById('prevMonthName').textContent = data.previous.month_name;
            document.getElementById('prevMonthCount').textContent = data.previous.count;
            document.getElementById('currMonthName').textContent = data.current.month_name;
            document.getElementById('currMonthCount').textContent = data.current.count;

            const changeEl = document.getElementById('comparisonChange');
            const change = data.change_percent;

            if (change > 0) {
                changeEl.textContent = `+${change}%`;
                changeEl.className = 'comparison-change positive';
            } else if (change < 0) {
                changeEl.textContent = `${change}%`;
                changeEl.className = 'comparison-change negative';
            } else {
                changeEl.textContent = '0%';
                changeEl.className = 'comparison-change neutral';
            }
        }

        // ============================================
        // EXPORT
        // ============================================
        async function downloadBackup() {
            try {
                const response = await fetch('/api/export/full');
                const data = await response.json();
                downloadJSON(data, 'gym_tracker_backup.json');
            } catch (error) {
                console.error('Error downloading backup:', error);
                alert('B≈ÇƒÖd pobierania backupu');
            }
        }

        async function downloadWorkouts() {
            try {
                const response = await fetch('/api/export/workouts');
                const data = await response.json();
                downloadJSON(data, 'workouts_backup.json');
            } catch (error) {
                console.error('Error downloading workouts:', error);
                alert('B≈ÇƒÖd pobierania trening√≥w');
            }
        }

        function downloadJSON(data, filename) {
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ============================================
        // STRENGTH TAB
        // ============================================
        async function loadStrengthData() {
            try {
                const userParam = currentUser ? `?user_id=${currentUser.user_id}` : '';
                const response = await fetch(`/api/strength${userParam}`);
                const data = await response.json();

                // Records
                renderRecords(data.records);

                // Populate dropdown
                populateProgressionSelect(data.body_parts_config);
            } catch (error) {
                console.error('Error loading strength data:', error);
            }
        }

        function renderRecords(records) {
            const container = document.getElementById('recordsGrid');

            if (!records || Object.keys(records).length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 30px; color: var(--text-muted);">
                        Brak rekord√≥w. Dodaj treningi z ciƒô≈ºarami!
                    </div>
                `;
                return;
            }

            container.innerHTML = '';

            for (const [part, record] of Object.entries(records)) {
                const card = document.createElement('div');
                card.className = 'record-card';
                card.style.cssText = `
                    background: var(--bg-input);
                    border-radius: 12px;
                    padding: 14px;
                    text-align: center;
                `;
                card.innerHTML = `
                    <div style="font-size: 0.85rem; font-weight: 600; color: var(--primary-light); margin-bottom: 6px; text-transform: uppercase;">${record.name}</div>
                    <div style="font-size: 1.3rem; font-weight: 800; color: var(--text-primary);">${record.kg} kg</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">${record.sets}√ó${record.reps}</div>
                    <div style="font-size: 0.65rem; color: var(--text-muted); margin-top: 4px;">${record.date}</div>
                `;
                container.appendChild(card);
            }
        }

        function populateProgressionSelect(config) {
            const select = document.getElementById('progressionSelect');
            select.innerHTML = '<option value="">Wybierz partiƒô cia≈Ça...</option>';

            for (const [key, part] of Object.entries(config || bodyPartsConfig)) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `${part.emoji} ${part.name}`;
                select.appendChild(option);
            }
        }

        async function fetchProgression(part) {
            if (!part) {
                document.getElementById('progressionChart').innerHTML = `
                    <div style="text-align: center; width: 100%; color: var(--text-muted); font-size: 0.85rem;">
                        Wybierz partiƒô cia≈Ça aby zobaczyƒá progresjƒô
                    </div>
                `;
                return;
            }

            try {
                const userParam = currentUser ? `?user_id=${currentUser.user_id}` : '';
                const response = await fetch(`/api/progression/${part}${userParam}`);
                const data = await response.json();
                renderProgression(data.data || []);
            } catch (error) {
                console.error('Error fetching progression:', error);
            }
        }

        function renderProgression(data) {
            const container = document.getElementById('progressionChart');

            if (!data || data.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; width: 100%; color: var(--text-muted); font-size: 0.85rem;">
                        Brak danych dla tej partii cia≈Ça
                    </div>
                `;
                return;
            }

            const maxKg = Math.max(...data.map(d => d.kg), 1);
            const chartHeight = 120;
            const chartWidth = container.offsetWidth || 300;
            const padding = 30;

            // Calculate points for line
            const points = data.map((entry, i) => {
                const x = padding + (i * ((chartWidth - padding * 2) / Math.max(data.length - 1, 1)));
                const y = chartHeight - padding - ((entry.kg / maxKg) * (chartHeight - padding * 2));
                return { x, y, kg: entry.kg, date: entry.date };
            });

            // Create SVG line chart
            const pathData = points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ');

            // Create gradient area path
            const areaPath = pathData + ` L ${points[points.length - 1].x} ${chartHeight - padding} L ${points[0].x} ${chartHeight - padding} Z`;

            let svg = `
                <svg width="100%" height="${chartHeight + 30}" viewBox="0 0 ${chartWidth} ${chartHeight + 30}" style="overflow: visible;">
                    <defs>
                        <linearGradient id="lineGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color: var(--primary); stop-opacity: 0.3"/>
                            <stop offset="100%" style="stop-color: var(--primary); stop-opacity: 0"/>
                        </linearGradient>
                    </defs>
                    
                    <!-- Area fill -->
                    <path d="${areaPath}" fill="url(#lineGradient)" />
                    
                    <!-- Line -->
                    <path d="${pathData}" fill="none" stroke="var(--primary)" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                    
                    <!-- Points and labels -->
                    ${points.map(p => {
                const dateObj = new Date(p.date);
                const label = `${dateObj.getDate()}.${dateObj.getMonth() + 1}`;
                return `
                            <circle cx="${p.x}" cy="${p.y}" r="5" fill="var(--primary)" stroke="var(--bg-card)" stroke-width="2"/>
                            <text x="${p.x}" y="${p.y - 12}" text-anchor="middle" fill="var(--text-primary)" font-size="11" font-weight="600">${p.kg}</text>
                            <text x="${p.x}" y="${chartHeight + 15}" text-anchor="middle" fill="var(--text-muted)" font-size="10">${label}</text>
                        `;
            }).join('')}
                </svg>
            `;

            container.innerHTML = svg;
        }

        // ============================================
        // START
        // ============================================
        init();
    </script>
</body>

</html>